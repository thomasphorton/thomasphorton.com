<html>
  <head>
    <link rel="stylesheet" type="text/css" href="./../../style.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-28026409-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-28026409-1');
    </script>
  </head>
  <body>
    <header id="site-header">
      <h2>thomas p horton</h2>
      <h3>solutions builder</h3>
    </header>

    <article>
      <header>
        <a href="../../index.html">&lt;&lt;home</a>
        <h1 itemprop='name'>Building a Smart boat</h1>
        <time pubdate itemprop='datePublished'>
          jan 10, 2017
        </time>
      </header>
      
      <section itemprop='description'>
        <h1 id="mariah">Mariah</h1>

        <p>Last year, we bought a boat. She's old, and she's slow, but she floats and sails and that's pretty cool. There's not much to ole Mariah, but the guy that sold her to us included a solar panel to charge cell phones and power a small lamp, and that idea of owning something and making it your own to solve a problem put a little tickle in the back of my head. I knew that I wanted to make this boat my own, but I wasn't sure how.</p>

        <p>I think most people would take an old boat and gut the interior, give her some fresh varnish, or do some other cosmetic project. Mariah needs all of that, but I wanted to do something that I hadn't seen anyone else do before. I was going to give her a brain.</p>

        <h2 id="buildingasmartboatlocationservices">Building a Smart Boat: Location Services</h2>

        <p>The first thing a smart boat should do is let you know where it is.</p>

        <h3 id="materials">Materials</h3>

        <ul>
          <li>[ ] <a href="http://amzn.to/2CZ7Lzy">Raspberry Pi</a></li>
          <li>[ ] <a href="http://amzn.to/2CuXCcF">Adafruit Ultimate GPS Breakout</a></li>
          <li>[ ] <a href="http://amzn.to/2CYqrzh">USB to TTL Cable</a></li>
          <li>[ ] <a href="http://amzn.to/2COXpoP">Expansion Board</a> (optional)</li>
          <li>[ ] <a href="http://amzn.to/2CI313j">Breadboard</a> (optional)</li>
          <li>[ ] <a href="https://hologram.io/store/nova-global-3g-2g-cellular-modem">Hologram Nova Cellular Modem</a> (optional)</li>
        </ul>

        <h3 id="code">Code</h3>
        <ul>
          <li>[ ] <a href="https://github.com/thomasphorton/mariah">mariah</a></li>
        </ul>

        <h2 id="architecture">Architecture</h2>

        <p><diagram goes here></p>

        <p>The base architecture of the project is pretty simple.</p>

        <ol>
        <li>A daemon will run on the Raspberry Pi, which will collect data from the different sensors (GPS only at this time).</li>

        <li>The Pi will be registered as an AWS IoT device, and will send data to the IoT service on a given interval.</li>

        <li>Using the IoT Rules Engine, the data will be replicated to DynamoDB</li>
        </ol>

        <h2 id="usegpswithraspberrypi">Use GPS with Raspberry Pi</h2>

        <p>The first thing you'll want to do (after basic Raspberry Pi installation) is to hook up the GPS board. You can find pretty good instructions on the <a href="https://learn.adafruit.com/adafruit-ultimate-gps-on-the-raspberry-pi?view=all">Adafruit GPS guide</a></p>

        <p>Before you begin- make sure that you solder the contacts to the <a href="http://amzn.to/2CuXCcF">GPS Breakout</a>! The board won't work otherwise.</p>

        <p><picture of soldered board></p>

        <p>Go ahead and follow the guide's instructions to download the GPS daemon packages:</p>

        <p><code>sudo apt-get install gpsd gpsd-clients python-gps</code></p>

        <p>Once installed, you can start the daemon with</p>

        <p><code>sudo gpsd /dev/ttyUSB0 -F /var/run/gpsd.sock</code></p>

        <p>and test that you've got GPS fix with</p>

        <p><code>cgps -s</code></p>

        <h2 id="raspberrypigpswithnodejs">Raspberry Pi GPS with NodeJS</h2>

        <p>I'm a big NodeJS fan, so I've written my application with JS. Luckily, someone's already done the heavy lifting and has created <a href="https://github.com/eelcocramer/node-gpsd">node-gpsd</a>.</p>

        <p>Install the package in your working directory with:</p>

        <p><code>npm install --save node-gpsd</code></p>

        <p>Here's how you configure a GPS Daemon/Listener in NodeJS:</p>

        <pre><code>// app.js

const gpsd = require('node-gpsd');

const daemon = new gpsd.Daemon({
  program: 'gpsd',
  device: '/dev/ttyUSB0',
  port: 2947,
  pid: '/tmp/gpsd.pid',
  readOnly: false,
  logger: {
    info: function() {},
    warn: console.warn,
    error: console.error
  }
});

const listener = new gpsd.Listener({
  port: 2947,
  hostname: 'localhost',
  logger: {
    info: function() {},
    warn: console.lwarn,
    error: console.error
  },
  parse: true
});

daemon.start(() =&gt; {
  console.log('GPS Daemon started');

  listener.connect(() =&gt; {
    console.log('GPS Listener connected');

    listener.watch();

    listener.on('TPV', (e) =&gt; {
      console.log('event:', e);    
    });
  });
});
        </code></pre>

        <p>There are two objects being used here:</p>

        <p><strong>GPS Daemon</strong> - The daemon is what is actually interacting with the device, and polling it for changes. These changes get published to a local port.</p>

        <p><strong>GPS Listener</strong> - The listener is subscribed to events on that port, and trigger JavaScript events. This allows us to react to these new events.</p>

        <h3 id="testitout">Test It Out</h3>

        <p>Run the GPS service with <code>node app</code>. You should start to see different events logged to the console. Congratulations!</p>

        <h2 id="awsiotwithraspberrypi">AWS IoT with Raspberry Pi</h2>

        <p>Now that we're pulling GPS data, we should put it somewhere. <a href="https://aws.amazon.com/iot/">AWS IoT</a> offers many different services that we can tap into.</p>

        <h3 id="registeraniotdevice">Register an IoT Device</h3>

        <p>Navigate to the <a href="https://us-west-2.console.aws.amazon.com/iot/home?region=us-west-2#/connIntro">Onboard</a> dashboard of the AWS IoT console and click 'Get Started'. From here, follow the steps to download a package of certificates for your device. Copy the certs to your Raspberry Pi- I've got mine in my application folder (<code>mariah/certs</code>).</p>

        <p>Next, we'll add some code to connect to the IoT Cloud. Install the AWS IoT SDK for node:</p>

        <p><code>npm install --save aws-iot-device-sdk</code></p>

        <p>And change your <code>app.js</code> to look like this:</p>

        <pre><code>// app.js

const config = require('./config.js');

const gpsd = require('node-gpsd');
const deviceModule = require('aws-iot-device-sdk').device;

const daemon = new gpsd.Daemon({
  program: 'gpsd',
  device: '/dev/ttyUSB0',
  port: 2947,
  pid: '/tmp/gpsd.pid',
  readOnly: false,
  logger: {
    info: function() {},
    warn: console.warn,
    error: console.error
  }
});

const listener = new gpsd.Listener({
  port: 2947,
  hostname: 'localhost',
  logger: {
    info: function() {},
    warn: console.lwarn,
    error: console.error
  },
  parse: true
});

const device = deviceModule({
  keyPath: config.iot.keyPath,
  certPath: config.iot.certPath,
  caPath: config.iot.caPath,
  region: config.aws.region,
  host: config.iot.host
});

daemon.start(() =&gt; {
  console.log('GPS Daemon started');

  listener.connect(() =&gt; {
    console.log('GPS Listener connected');

    listener.watch();

    listener.on('TPV', (e) =&gt; {
      e.trip_id = 'trip_1';
      console.log('event:', e);    
      device.publish('gps', JSON.stringify(e));
    });
  });
});
        </code></pre>

        <p>All I've done here is declare a 'device', which requires the location of the certs that we transferred over to the Pi earlier. Once declared, we can use it to publish to the cloud: that's what this line is:</p>

        <p><code>device.publish('gps', JSON.stringify(e));</code></p>

        <p>where <code>gps</code> is a topic that we can act on once we get into the AWS IoT Rules Engine, and we're publishing our JSON from the GPS module as a string.</p>

        <h3 id="testitout-1">Test it Out</h3>

        <p>To test that this is working, go to the <a href="https://us-west-2.console.aws.amazon.com/iot/home?region=us-west-2#/test">Test</a> tab of the AWS IoT console and subscribe to the <code>gps</code> topic.</p>

        <p>Go back to your Pi, and run <code>node app</code> again. If everything is configured correctly, you should see data start to stream in.</p>

        <h2 id="usingtheiotrulesengine">Using the IoT Rules Engine</h2>

        <p>Data is flowing to the cloud like a firehose- now you need to put it somewhere. The AWS IoT Rules Engine allows you to use a SQL-like language to parse messages on the fly and act on them. Before we jump in though, we're going to need somewhere to dump them.</p>

        <h3 id="configureadynamodbtable">Configure a DynamoDB Table</h3>

        <p>Configure a DynamoDB table to hold the data. Setup is simple:</p>

        <img src="dynamo.png" alt="Configuration Options for DynamoDB Table">

        <ul>
          <li>Table name: <code>mariah-gps</code></li>
          <li>Partition key: <code>trip_id</code> String</li>
          <li>Sort key: <code>time</code> String</li>
          <li>Table settings: use default settings</li>
        </ul>

        <h3 id="configuringiotrulesengine">Configuring IoT Rules Engine</h3>

        <p>Now, go back to the <a href="https://us-west-2.console.aws.amazon.com/iot/home?region=us-west-2#/rulehub">IoT Rules console</a> and create a new rule.</p>

        <img src="./rules-condition.png" alt="IoT Rules Engine Conditions Configuration">

        <ul>
          <li>Name: <code>mariah_gps_rule</code></li>
          <li>Message source:
            <ul>
              <li>Attribute: <code>*</code></li>
              <li>Topic filter: <code>gps</code></li>
              <li>Condition: blank</li>
            </ul>
          </li>
        </ul>

        <img src="./rules-action.png" alt="IoT Rules Engine Actions Configuration">

        <ul>
          <li>Actions:
            <ul>
              <li>Split message into multiple columns of a database
                <ul>
                  <li>Table name: <code>mariah-gps</code></li>
                  <li>Iam role name: Create a new role</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>

        <h3 id="testitout-2">Test it Out</h3>

        <p>Go back to your app and run it again with <code>node app</code>. Open up your DynamoDB table, and you should see it populated with data.</p>

        <h2 id="nextsteps">Next Steps</h2>

        <p>Now that you've got location data up into the Cloud, you're free to do whatever you want with it. I'm writing a Lambda function to gather data by trip ID and mash it together into geoJSON- a format that will allow me to plot the trip out onto a map.</p>
      </section>

      <a href="../../index.html">&lt;&lt;home</a>
    </article>

  </body>
</html>
